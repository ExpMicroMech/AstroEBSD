# Notes on building phase files and dynamical templates

Last updated: November 20, 2024

by Tianbi Zhang, with contributions from Haroon Qaiser

Many features of AstroEBSD, such as the refined template matching (RTM) method, require a simulated "dynamic template" of a material. This template is essentially the "diffraction/reference sphere" stored in an ASCII format. The sphere is often presented as a 2D projection, and is read by AstroEBSD (specifically, `Cube_Generate`) to generate a gnomonic pattern.

This article will introduce a few methods to obtain the templates, as well as other files needed to facilitate the simulations.

The majority of the following sections are taken from the previous tutorial document written by Alex Foden: CIF file, phase file, Espirit DynamicS.


## CIF File (.cif)

A crystallographic information file (.cif; "CIF file" hereafter) is a structured text file containing e.g. the symmetry of the unit cell and atomic positions of the structure. It is required for both template simulation and all MTEX functions using crystal symmetry. 

CIF files of many common materials are included in the public version of AstroEBSD (some of which are taken from MTEX). If the CIF file of your material is not available by default, there are a few ways to obtain it:

- Search for the structure in databases, such as the [Crystallography open database (COD)](http://www.crystallography.net/cod/) and the [Cambridge Structural Database](https://www.ccdc.cam.ac.uk/structures/).
- If a particular phase was determined from another technique (e.g. PXRD), you may ask for the CIF file or get it from the analysis software.
- If you cannot find a CIF file but the unit cell information is known, you may also recreate the structure in [VESTA](http://jp-minerals.org/vesta/en/) and export the crystal structure. [Here](http://jp-minerals.org/vesta/en/doc/VESTA.html) is a tutorial and you can also find one in Dr. Foden's tutorial. The relevant section is "6 GIVING PHASE DATA". Once the structure is properly built, you can go to ''File'' - "Export Data" and select the ".cif" format.

By default, CIF files are stored in AstroEBSD\_Home\_Directory/phases/cifs.

## Phase File (.pha)

A phase file (.pha) is a structured text file used by AstroEBSD to obtain crystallographic information. Again, files of many common materials are included in the public version of AstroEBSD. If the file is not available for your material, you may build one by duplicating an existing one as a template, and manually modifying the fields. 

In AstroEBSD, you need to address the phase by the name of the .pha file. This is useful for differentiating different templates of the same structure (e.g. they may be simulated by different methods or at different conditions, especially primary electron energy).

By default, phase files are stored in `AstroEBSD\_Home\_Directory/phases/phasefiles`.

As .pha and .cif are text files, you can open and edit them with any text editing tools (e.g. Notepad on Windows).

Below is a typical .pha file:

```
$Name
Silicon
$Atoms
0,0,0;1/3,2/3,1/4;
$Symmetry
1
$Lattice
5.431,5.431,5.431,90,90,90
$FFactor
2,2
$MaxFam
7
$MaxIndex
10
$EFac
100
$PlaneReflector
0,-2,2;0,4,0;1,-3,-1;2,-4,2;1,-3,-3;1,1,1;
$cif
Si-Silicon.cif
$isHex
0
$sim_type
bwkd
$dynamic
Si_hemi_20240806_223301.bwkd
```

Note that each field is denoted by "\$" and the corresponding information is listed in the next row. Order does not matter.

Information for the following fields can be directly taken from CIF files. As such, you may develop scripts to automatically fill in these fields.

- `$Name`: String. the name of the phase. 
- `$Atoms`: Double. fractional coordinates of each atoms
- `$Symmetry`: Integer. Note that after the most recent update to Phase_Builder_RTM, this field is being deprecated and symmetry operations are extracted from CIF files using an MTEX function.
- `$Lattice`: lattice parameters of the unit cell, in the order of a, b, c, alpha, beta, gamma
- `$FFactor`: atomic scattering factor. They are used along with `$Atoms` for calculating structure factors.

Below are customized information:

- `$MaxFam`: the maximum number of families of crystallographic planes considered by AstroEBSD.
- `$MaxIndex`, `$EFac`: unknown.
- `$PlaneReflector`: list of plane reflectors (Miller indices) to be considered for indexing and plotting. Each reflector is seperated by a semicolon (;).
- `$cif`: name of the CIF file **with** the ".cif " extension, or the name of a structure that is included in MTEX by default (e.g. "Si-Silicon"). For the former option, you will get an error if the extension is not included.
- `$isHex`: integer. 0 if the structure is not hexagonal, 1 if it is. 
- `$sim_type`: string. This represents the simulation method. Case insensitive. 
   - `bwkd`: templates generated by the "bwkd" simulation method; template is a .txt file, drive file is a .bwkd file (which is essentially a JSON file).
   - `EMSoft`: templates generated by EMSoft; template is a .h5 file.
   - If this field is omitted, AstroEBSD will default to `dynamics` and the program will look for a .bin file.
- `$dynamic`: name of the template file, case insensitive. There are different requirements for different options of \$sim_type:
   - `bwkd`: You need to provide the name of the template either with (.bwkd) or without the extension. Both the drive file (.bwkd, which provided metadata) and the tenplate (.txt) must be presented in the template folder, and named the same.
   - `dynamics`: Name of the .bin file **with** the extension (.bin).
   - `EMSoft`: You need to provide the name of the template either with (.h5) or without the extension. 
- If you get an "Invalid file identifier" error in MATLAB, it's very likely that there is a typo in the file names in `$cif` or `$dynamic`, or a missing .cif and/or .bin extension.

## Template Simulation

 Please note that after the update in November 2024, the folder containing the template is renamed to `AstroEBSD\_Home\_Directory/phases/dynamic_templates`.

 To use any of the three methods below, you must have a CIF file of your structure.

### BWKD

BWKD (Bloch Wave Kikuchi Diffraction) is a simulation package developed by Winklemann et al. This generates the diffraction sphere in the form of stereographic projection, with the projections of the two hemispheres stacked. 

The BWKD format is adapted in AstroEBSD for reference spheres reconstructed from experimental pattern(s). To do so, one can first perform the reprojection and reconstruction of the stereogram using the `decks/stereo_reprojection` code to obtain a stereogram (2001x2001 by default), then manually stack the stereograms and export it as a .txt file. A BWKD file is still required where the row and column numbers must be adjusted to 2001 (or your custom setting).

### EMsoft

EMsoft is an open source simulation package developed by De Graef et al. Simulations are typically done on high performance computation centres for speed, especially for high quality simulations. 

Templates simulated by EMSoft are hierarchial data format files with a ".h5" extension. The diffraction sphere is presented in the form of a modified Lambert projection.

### Espirit DynamicS

You may refer to the previous tutorial document by Dr. Alex Foden for simulation using Espirit Dynamics. The diffraction sphere is presented as a 'cube' pattern.

### Note on Axis Convention

Templates generated by BWKD follow the axis convention described in the CIF file.

For templates generated by both **EMSoft** and **DynamicS**, axis convention may be different from the one stipulated in the CIF file, especially in low-symmetry materials (notably orthorhombic unit cells). For example, a Pbnm orthorhombic structure will be shifted to a Pnma orthorhombic structure. There are a few implications:

- The Euler Angles will be different. In the Pbnm-Pnma case with an ECP, this can be done by introducing two additional rotations by 90 degrees [^Euler]. 
- To interpret the Kikuchi bands (and possibly diffraction spots), you need to cyclicly shift the Miller indices and/or potentially use a phase file with shifted axes.

